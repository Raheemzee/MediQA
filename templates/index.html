<!DOCTYPE html>
<html>
<head>
  <title>Health GPT Chatbot</title>
  <style>
    body { font-family: Arial; background: #ab0bef; padding: 40px; }
    .chat-container { background: white; padding: 20px; border-radius: 10px; max-width: 700px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .chat-box { margin-top: 20px; }
    .user, .bot { margin: 10px 0; }
    .user { color: #007BFF; font-weight: bold; }
    .bot { color: #28a745; font-weight: bold; }
    .controls { margin-top: 20px; text-align: center; }
    button { margin: 5px; padding: 10px 16px; border: none; border-radius: 8px; background: #007BFF; color: white; cursor: pointer; font-size: 16px; }
    button:disabled { background: gray; cursor: not-allowed; }
    button:hover:enabled { background: #0056b3; }
    #mic-btn.recording { background: red; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.6);} 70% { box-shadow: 0 0 0 15px rgba(255,0,0,0);} 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0);} }
    #status { text-align:center; color:#fff; margin-top:10px; }
  </style>
</head>
<body>
  <h1 style="color: azure; font-family: Georgia, 'Times New Roman', Times, serif; font-size: x-large; text-align: center;">
    MediQA
  </h1>

  <div class="chat-container">
    <h2>Ask Your Health Questions</h2>

    <!-- Text Input -->
    <form action="/get_response" method="post">
      <input type="text" name="user_input" placeholder="Enter your health question..." style="width: 70%;" required>
      <button type="submit">Ask</button>
    </form>

    <!-- Voice Controls -->
    <div class="controls">
      <h3>üé§ Voice Mode</h3>
      <button id="mic-btn" type="button"
              onmousedown="startRecording(this)"
              onmouseup="stopRecording(this)"
              ontouchstart="startRecording(this)"
              ontouchend="stopRecording(this)">
        üéôÔ∏è Hold to Talk
      </button>
    </div>

    {% if user_input %}
    <div class="chat-box">
      <div class="user">You: {{ user_input }}</div>
      <div class="bot">Bot: {{ chatbot_response }}</div>
      <button onclick="speak('{{ chatbot_response }}', this)">üîä Listen to Reply</button>
    </div>
    {% endif %}

    <!-- Voice Results -->
    <div id="voice-results" class="chat-box" style="display:none;">
      <div class="user" id="voice-transcript"></div>
      <div class="bot" id="voice-response"></div>
      <button id="voice-play" style="display:none;">üîä Listen to Reply</button>
    </div>
  </div>

  <div id="status"></div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isSpeaking = false;

    function setStatus(msg) {
      document.getElementById("status").innerText = msg || "";
    }

    async function startRecording(btn) {
      if (isRecording || isSpeaking) return;
      isRecording = true;
      btn.disabled = false;
      btn.classList.add("recording");
      btn.innerText = "üéôÔ∏è Recording...";
      setStatus("Recording‚Ä¶ release to send");

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const options = { mimeType: "audio/webm;codecs=opus" };
      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.start();
    }

    function stopRecording(btn) {
      if (!isRecording) return;
      isRecording = false;
      btn.classList.remove("recording");
      btn.innerText = "üéôÔ∏è Hold to Talk";
      setStatus("Processing‚Ä¶");

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob, "speech.webm");

        fetch("/stt", { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            setStatus("");
            document.getElementById("voice-results").style.display = "block";
            document.getElementById("voice-transcript").innerText = "You (voice): " + (data.transcript || "(no speech detected)");
            document.getElementById("voice-response").innerText = "Bot: " + (data.response || "");

            const playBtn = document.getElementById("voice-play");
            playBtn.style.display = "inline-block";
            playBtn.disabled = false;
            playBtn.onclick = () => speak(data.response, playBtn);
          })
          .catch(err => {
            setStatus("Error: " + err);
            console.error(err);
          })
          .finally(() => {
            audioChunks = [];
          });
      };

      mediaRecorder.stop();
    }

    function speak(text, btn) {
      if (!text) return;
      if (isSpeaking || isRecording) return;
      isSpeaking = true;
      if (btn) btn.disabled = true;

      fetch("/speak_response", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      })
      .then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.playbackRate = 1.5; // üî• faster playback
        audio.onended = () => {
          isSpeaking = false;
          if (btn) btn.disabled = false;
        };
        audio.play();
      })
      .catch(err => {
        isSpeaking = false;
        if (btn) btn.disabled = false;
        console.error(err);
      });
    }
  </script>
</body>
</html>
